# Audit Report: Task 2

### Audited by Sajjad Keshavarz (sajjadkeshavarz@proton.me)

## Critical

### Critical-1
**File:** `src/RapBattle.sol`

**Line:** 62

**Issue:** The `keccak256` function is used to generate a random value, but this random value cannot be trusted. A malicious user can exploit this to always be the challenger and ensure they win.

**Exploit Example:**
```solidity
contract Attack {
    function battle(uint256 _tokenId, uint256 _credBet) external onlyOwner {
        require(rapBattle.defender != address(0));

        uint256 balanceBefore = credContract.balanceOf(address(this));
        callgoOnStageOrBattle(_tokenId, _credBet);

        require(balanceBefore == balanceBefore + _credBet);
    }
}
```

**Impact:** This allows the attacker to always be the challenger and manipulate the outcome to always win the battle.

**Fix:** Use `ChainLink VRF` to generate random values.

---

## High

### High-1
**File:** `src/RapBattle.sol`

**Line:** 38

**Function:** `goOnStageOrBattle`

**Issue:** Defenders always have a greater chance of winning. Consider the following:

- `defenderRapperSkill = 10`
- `challengerRapperSkill = 10`

The random number generated by:
```solidity
uint256 random = uint256(keccak256(abi.encodePacked(block.timestamp, block.prevrandao, msg.sender))) % totalBattleSkill;
```
will be a value from 0 to 19. Even with equal skills, the condition:
```solidity
if (random <= defenderRapperSkill)
```
at line 70 results in the defender having a 55% chance to win.

**Fix:** Remove the `=` and check if `random < defenderRapperSkill`.

---

## Info

### Info-1
**File:** `src/RapBattle.sol`

**Line:** 60

**Issue:** The `totalPrize` is defined and calculated, but its value is never used.

---

### Info-2
**File:** `src/RapBattle.sol` and `src/Streets.sol`

**Lines:** 80

**Issue:** It is better to use `safeTransferFrom` instead of `transferFrom` to ensure that the NFT does not get locked up in an address from which we can never retrieve it.

---

## Gas Optimization

### Gas-1
**File:** `src/Streets.sol`

**Function:** `unstake`

**Issue:** To reduce gas usage, avoid calling `mint` multiple times.

**Proposed Change:**
```diff
function unstake(uint256 tokenId) external {
    ...
    // Apply changes based on the days staked
    if (daysStaked >= 1) {
        stakedRapperStats.weakKnees = false;
-        credContract.mint(msg.sender, 1);
    }
    if (daysStaked >= 2) {
        stakedRapperStats.heavyArms = false;
-        credContract.mint(msg.sender, 1);
    }
    if (daysStaked >= 3) {
        stakedRapperStats.spaghettiSweater = false;
-        credContract.mint(msg.sender, 1);
    }
    if (daysStaked >= 4) {
        stakedRapperStats.calmAndReady = true;
-        credContract.mint(msg.sender, 1);
    }
+    uint256 credToMint = daysStaked > 4 ? 4 : daysStaked;
+    credContract.mint(msg.sender, credToMint);
    ...
}
```

---

By addressing these issues, the security and efficiency of the RapBattle and Streets smart contracts can be significantly improved.
